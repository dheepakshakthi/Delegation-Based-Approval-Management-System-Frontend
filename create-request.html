<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Request - DBAMS</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="dashboard.html" class="sidebar-brand">DBAMS</a>
      
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Dashboard</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="requests.html">Requests</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link active" href="create-request.html">Create Request</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="pending-approvals.html">Pending Approvals</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="delegations.html">Delegations</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="create-delegation.html">Create Delegation</a>
        </li>
        <li class="nav-item" data-show-role="Admin">
          <a class="nav-link" href="users.html">Users</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profile.html">Profile</a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-name" id="userName">User</div>
          <div class="sidebar-user-role" id="userRole">Role</div>
          <a href="#" class="sidebar-logout" onclick="logout()">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container-fluid">
      <!-- Page Header -->
      <div class="page-header">
        <h2 class="page-title">Create New Request</h2>
        <p class="text-muted mb-0">Fill out the form below to submit a new approval request.</p>
      </div>

      <!-- Request Form -->
      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">Request Details</div>
            <div class="card-body">
              <form id="createRequestForm">
                <div class="mb-3">
                  <label for="title" class="form-label">Request Title *</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="title" 
                    maxlength="200"
                    placeholder="Enter a descriptive title for your request"
                    required
                  >
                  <div class="invalid-feedback">
                    Please enter a title (max 200 characters).
                  </div>
                </div>

                <div class="mb-3">
                  <label for="requestType" class="form-label">Request Type *</label>
                  <select class="form-select" id="requestType" required>
                    <option value="">Select request type</option>
                    <option value="Leave">Leave</option>
                    <option value="Purchase">Purchase</option>
                    <option value="Budget">Budget</option>
                    <option value="Project">Project</option>
                    <option value="Policy">Policy</option>
                    <option value="Other">Other</option>
                  </select>
                  <div class="invalid-feedback">
                    Please select a request type.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="priority" class="form-label">Priority *</label>
                  <select class="form-select" id="priority" required>
                    <option value="">Select priority</option>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Urgent">Urgent</option>
                  </select>
                  <div class="invalid-feedback">
                    Please select a priority level.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="approver" class="form-label">Approver *</label>
                  <select class="form-select" id="approver" required>
                    <option value="">Loading approvers...</option>
                  </select>
                  <div class="invalid-feedback">
                    Please select an approver.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="amount" class="form-label">Amount (Optional)</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="amount"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                    >
                  </div>
                  <small class="text-muted">Enter amount if applicable (e.g., for purchase or budget requests)</small>
                </div>

                <div class="mb-3">
                  <label for="description" class="form-label">Description *</label>
                  <textarea 
                    class="form-control" 
                    id="description" 
                    rows="6"
                    placeholder="Provide detailed information about your request"
                    required
                  ></textarea>
                  <div class="invalid-feedback">
                    Please enter a description.
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">Submit Request</button>
                  <a href="requests.html" class="btn btn-secondary">Cancel</a>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Help Section -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">Guidelines</div>
            <div class="card-body">
              <h6 class="text-green">Request Submission Tips:</h6>
              <ul class="small">
                <li>Provide a clear and descriptive title</li>
                <li>Include all relevant details in the description</li>
                <li>Select the appropriate request type</li>
                <li>Set the correct priority level</li>
                <li>Choose the right approver for your request</li>
                <li>Add amount for financial requests</li>
              </ul>
              
              <h6 class="text-green mt-3">Priority Levels:</h6>
              <ul class="small">
                <li><strong>Urgent:</strong> Requires immediate attention</li>
                <li><strong>High:</strong> Important, needs quick review</li>
                <li><strong>Medium:</strong> Normal priority</li>
                <li><strong>Low:</strong> Can wait if needed</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- App Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  
  <script>
    // Load approvers on page load
    async function loadApprovers() {
      try {
        const response = await userAPI.getUsersByRole('Approver');
        const approverSelect = document.getElementById('approver');
        
        if (response.success && response.data && response.data.length > 0) {
          approverSelect.innerHTML = '<option value="">Select an approver</option>' +
            response.data.map(user => 
              `<option value="${user._id}">${user.name} (${user.department || 'No Dept'})</option>`
            ).join('');
        } else {
          // Also try to get Admin users if no approvers found
          const adminResponse = await userAPI.getUsersByRole('Admin');
          if (adminResponse.success && adminResponse.data && adminResponse.data.length > 0) {
            approverSelect.innerHTML = '<option value="">Select an approver</option>' +
              adminResponse.data.map(user => 
                `<option value="${user._id}">${user.name} (Admin)</option>`
              ).join('');
          } else {
            approverSelect.innerHTML = '<option value="">No approvers available</option>';
            showError('No approvers found. Please contact administrator.');
          }
        }
      } catch (error) {
        console.error('Error loading approvers:', error);
        showError('Failed to load approvers');
      }
    }

    // Handle form submission
    document.getElementById('createRequestForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get form values
      const title = document.getElementById('title').value.trim();
      const requestType = document.getElementById('requestType').value;
      const priority = document.getElementById('priority').value;
      const approver = document.getElementById('approver').value;
      const amount = document.getElementById('amount').value;
      const description = document.getElementById('description').value.trim();
      
      // Validate
      if (!title || !requestType || !priority || !approver || !description) {
        showError('Please fill in all required fields');
        return;
      }
      
      // Disable submit button
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
      
      try {
        // Prepare request data
        const requestData = {
          title,
          requestType,
          priority,
          approver,
          description
        };
        
        // Add amount if provided
        if (amount && parseFloat(amount) > 0) {
          requestData.amount = parseFloat(amount);
        }
        
        // Submit request
        const response = await requestAPI.createRequest(requestData);
        
        if (response.success) {
          showSuccess('Request submitted successfully!');
          
          // Redirect to request details page after short delay
          setTimeout(() => {
            window.location.href = `request-details.html?id=${response.data._id}`;
          }, 1000);
        } else {
          showError(response.message || 'Failed to submit request');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      } catch (error) {
        showError(error.message || 'An error occurred while submitting the request');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // Clear invalid state on input
    document.querySelectorAll('.form-control, .form-select').forEach(input => {
      input.addEventListener('input', function() {
        this.classList.remove('is-invalid');
      });
    });

    // Load approvers when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadApprovers();
    });
  </script>
      </div>
    </main>
  </div>
</body>
</html>
