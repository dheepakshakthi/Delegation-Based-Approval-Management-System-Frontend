<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pending Approvals - DBAMS</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="dashboard.html" class="sidebar-brand">DBAMS</a>
      
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Dashboard</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="requests.html">Requests</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="create-request.html">Create Request</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link active" href="pending-approvals.html">Pending Approvals</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="delegations.html">Delegations</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="create-delegation.html">Create Delegation</a>
        </li>
        <li class="nav-item" data-show-role="Admin">
          <a class="nav-link" href="users.html">Users</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profile.html">Profile</a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-name" id="userName">User</div>
          <div class="sidebar-user-role" id="userRole">Role</div>
          <a href="#" class="sidebar-logout" onclick="logout()">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container-fluid">
      <!-- Page Header -->
      <div class="page-header">
        <h2 class="page-title">Pending Approvals</h2>
        <p class="text-muted mb-0">Review and approve/reject pending requests assigned to you.</p>
      </div>

      <!-- Filters -->
      <div class="filter-section">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="filterStatus" class="form-label">Status</label>
            <select class="form-select" id="filterStatus">
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="">All Status</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label for="filterType" class="form-label">Type</label>
            <select class="form-select" id="filterType">
              <option value="">All Types</option>
              <option value="Leave">Leave</option>
              <option value="Purchase">Purchase</option>
              <option value="Budget">Budget</option>
              <option value="Project">Project</option>
              <option value="Policy">Policy</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label for="filterPriority" class="form-label">Priority</label>
            <select class="form-select" id="filterPriority">
              <option value="">All Priorities</option>
              <option value="Urgent">Urgent</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label for="sortBy" class="form-label">Sort By</label>
            <select class="form-select" id="sortBy">
              <option value="date">Date (Newest)</option>
              <option value="priority">Priority (Highest)</option>
              <option value="requester">Requester Name</option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" onclick="loadPendingApprovals()">Apply Filters</button>
          </div>
        </div>
      </div>

      <!-- Pending Approvals Table -->
      <div class="card">
        <div class="card-header" id="tableHeader">Requests Awaiting Your Approval</div>
        <div class="card-body">
          <div id="approvalsContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Approve Modal -->
  <div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Approve Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to approve this request?</p>
          <div id="approveRequestInfo"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmApproveBtn">Approve</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rejection Modal -->
  <div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reject Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="rejectForm">
            <div class="mb-3">
              <label for="rejectionReason" class="form-label">Reason for Rejection *</label>
              <textarea 
                class="form-control" 
                id="rejectionReason" 
                rows="4"
                placeholder="Please provide a reason for rejecting this request..."
                required
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmRejectBtn">Reject Request</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- App Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  
  <script>
    let approveModal, rejectModal;
    let currentRequestId = null;

    // Load pending approvals
    async function loadPendingApprovals() {
      showLoading('approvalsContainer');
      
      try {
        // Get filter values
        const status = document.getElementById('filterStatus').value;
        const requestType = document.getElementById('filterType').value;
        const priority = document.getElementById('filterPriority').value;
        const sortBy = document.getElementById('sortBy').value;
        
        // Update card header based on status filter
        const headerText = status === 'Approved' ? 'Approved Requests' : 
                          status === 'Rejected' ? 'Rejected Requests' :
                          status === '' ? 'All Requests' : 'Requests Awaiting Your Approval';
        document.getElementById('tableHeader').textContent = headerText;
        
        // Build filter params
        const params = {};
        if (status) params.status = status;
        if (requestType) params.requestType = requestType;
        if (priority) params.priority = priority;
        
        // Fetch requests with filters
        const response = await requestAPI.getRequests(params);
        
        if (response.success && response.data && response.data.length > 0) {
          let requests = response.data;
          
          // Sort requests
          if (sortBy === 'priority') {
            const priorityOrder = { 'Urgent': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
            requests.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
          } else if (sortBy === 'requester') {
            requests.sort((a, b) => (a.requester?.name || '').localeCompare(b.requester?.name || ''));
          } else {
            // Sort by date (newest first)
            requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
          }
          
          if (requests.length === 0) {
            showEmptyState('approvalsContainer', 'No requests match your filters');
            return;
          }
          
          // Display requests
          const html = `
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Requester</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${requests.map(request => `
                    <tr>
                      <td>
                        <a href="request-details.html?id=${request._id}" class="text-decoration-none fw-bold">
                          ${truncateText(request.title, 50)}
                        </a>
                      </td>
                      <td>${request.requester?.name || 'N/A'}</td>
                      <td>${getRequestTypeBadge(request.requestType)}</td>
                      <td>${getPriorityBadge(request.priority)}</td>
                      <td>${getStatusBadge(request.status)}</td>
                      <td>${request.amount ? formatCurrency(request.amount) : '-'}</td>
                      <td>${formatDate(request.submittedAt)}</td>
                      <td>
                        <div class="action-buttons">
                          <a href="request-details.html?id=${request._id}" class="btn btn-sm btn-outline-primary">View</a>
                          ${request.status === 'Pending' ? `
                            <button class="btn btn-sm btn-success" onclick="showApproveModal('${request._id}', '${request.title}')">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="showRejectModal('${request._id}')">Reject</button>
                          ` : ''}
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
          
          hideLoading('approvalsContainer', html);
        } else {
          const emptyMessage = status === 'Approved' ? 'No approved requests found' :
                              status === 'Rejected' ? 'No rejected requests found' :
                              status === '' ? 'No requests found' : 'No pending approvals at this time';
          showEmptyState('approvalsContainer', emptyMessage);
        }
      } catch (error) {
        console.error('Error loading requests:', error);
        hideLoading('approvalsContainer', `
          <div class="alert alert-danger">
            Failed to load requests. Please try again.
          </div>
        `);
      }
    }

    // Show approve modal
    function showApproveModal(requestId, title) {
      currentRequestId = requestId;
      document.getElementById('approveRequestInfo').innerHTML = `
        <strong>Request:</strong> ${title}
      `;
      approveModal.show();
    }

    // Show reject modal
    function showRejectModal(requestId) {
      currentRequestId = requestId;
      document.getElementById('rejectionReason').value = '';
      rejectModal.show();
    }

    // Approve request
    document.getElementById('confirmApproveBtn').addEventListener('click', async function() {
      if (!currentRequestId) return;
      
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Approving...';
      
      try {
        const response = await requestAPI.approveRequest(currentRequestId);
        
        if (response.success) {
          showSuccess('Request approved successfully');
          approveModal.hide();
          loadPendingApprovals();
        } else {
          showError(response.message || 'Failed to approve request');
        }
      } catch (error) {
        showError(error.message || 'An error occurred');
      } finally {
        this.disabled = false;
        this.innerHTML = 'Approve';
      }
    });

    // Reject request
    document.getElementById('confirmRejectBtn').addEventListener('click', async function() {
      if (!currentRequestId) return;
      
      const reason = document.getElementById('rejectionReason').value.trim();
      
      if (!reason) {
        showError('Please provide a reason for rejection');
        return;
      }
      
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';
      
      try {
        const response = await requestAPI.rejectRequest(currentRequestId, reason);
        
        if (response.success) {
          showSuccess('Request rejected successfully');
          rejectModal.hide();
          loadPendingApprovals();
        } else {
          showError(response.message || 'Failed to reject request');
        }
      } catch (error) {
        showError(error.message || 'An error occurred');
      } finally {
        this.disabled = false;
        this.innerHTML = 'Reject Request';
      }
    });

    // Apply filters
    document.getElementById('filterStatus').addEventListener('change', loadPendingApprovals);
    document.getElementById('filterType').addEventListener('change', loadPendingApprovals);
    document.getElementById('filterPriority').addEventListener('change', loadPendingApprovals);
    document.getElementById('sortBy').addEventListener('change', loadPendingApprovals);

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Require Approver or Admin role
      requireAnyRole(['Approver', 'Admin']);
      
      approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
      rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
      
      loadPendingApprovals();
    });
  </script>
      </div>
    </main>
  </div>
</body>
</html>
