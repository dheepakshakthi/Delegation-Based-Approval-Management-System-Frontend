<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Requests - DBAMS</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="dashboard.html" class="sidebar-brand">DBAMS</a>
      
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Dashboard</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link active" href="requests.html">Requests</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="create-request.html">Create Request</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="pending-approvals.html">Pending Approvals</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="delegations.html">Delegations</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="create-delegation.html">Create Delegation</a>
        </li>
        <li class="nav-item" data-show-role="Admin">
          <a class="nav-link" href="users.html">Users</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profile.html">Profile</a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-name" id="userName">User</div>
          <div class="sidebar-user-role" id="userRole">Role</div>
          <a href="#" class="sidebar-logout" onclick="logout()">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container-fluid">
      <!-- Page Header -->
      <div class="page-header d-flex justify-content-between align-items-center">
        <div>
          <h2 class="page-title">My Requests</h2>
          <p class="text-muted mb-0">View and manage all your approval requests.</p>
        </div>
        <a href="create-request.html" class="btn btn-primary">+ New Request</a>
      </div>

      <!-- Filters -->
      <div class="filter-section">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="filterStatus" class="form-label">Status</label>
            <select class="form-select" id="filterStatus">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label for="filterType" class="form-label">Type</label>
            <select class="form-select" id="filterType">
              <option value="">All Types</option>
              <option value="Leave">Leave</option>
              <option value="Purchase">Purchase</option>
              <option value="Budget">Budget</option>
              <option value="Project">Project</option>
              <option value="Policy">Policy</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label for="filterPriority" class="form-label">Priority</label>
            <select class="form-select" id="filterPriority">
              <option value="">All Priorities</option>
              <option value="Urgent">Urgent</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" onclick="loadRequests()">Apply Filters</button>
          </div>
        </div>
      </div>

      <!-- Requests Table -->
      <div class="card">
        <div class="card-header">All Requests</div>
        <div class="card-body">
          <div id="requestsContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- App Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  
  <script>
    // Load requests
    async function loadRequests() {
      showLoading('requestsContainer');
      
      try {
        const user = getCurrentUser();
        
        // Get filter values
        const status = document.getElementById('filterStatus').value;
        const requestType = document.getElementById('filterType').value;
        const priority = document.getElementById('filterPriority').value;
        
        // Build filter params
        const params = {};
        if (status) params.status = status;
        if (requestType) params.requestType = requestType;
        if (priority) params.priority = priority;
        
        // Fetch requests based on role
        let response;
        if (user.role === 'Requester') {
          // Requesters see only their own requests
          response = await requestAPI.getMyRequests();
        } else {
          // Approvers and Admins see all accessible requests with filters
          response = await requestAPI.getRequests(params);
        }
        
        if (response.success && response.data && response.data.length > 0) {
          let requests = response.data;
          
          // Apply filters manually if needed (backend should handle this)
          if (status) requests = requests.filter(r => r.status === status);
          if (requestType) requests = requests.filter(r => r.requestType === requestType);
          if (priority) requests = requests.filter(r => r.priority === priority);
          
          if (requests.length === 0) {
            showEmptyState('requestsContainer', 'No requests match your filters');
            return;
          }
          
          // Display requests table
          const html = `
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    ${user.role !== 'Requester' ? '<th>Requester</th>' : ''}
                    <th>Approver</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${requests.map(request => `
                    <tr>
                      <td>
                        <a href="request-details.html?id=${request._id}" class="text-decoration-none fw-bold">
                          ${request.title}
                        </a>
                      </td>
                      <td>${getRequestTypeBadge(request.requestType)}</td>
                      <td>${getPriorityBadge(request.priority)}</td>
                      <td>${getStatusBadge(request.status)}</td>
                      ${user.role !== 'Requester' ? `<td>${request.requester?.name || 'N/A'}</td>` : ''}
                      <td>${request.approver?.name || 'N/A'}</td>
                      <td>${formatDate(request.submittedAt)}</td>
                      <td>
                        <div class="action-buttons">
                          <a href="request-details.html?id=${request._id}" class="btn btn-sm btn-outline-primary">View</a>
                          ${request.status === 'Pending' && request.requester?._id === user.id ? `
                            <button class="btn btn-sm btn-danger" onclick="cancelRequest('${request._id}')">Cancel</button>
                          ` : ''}
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
          
          hideLoading('requestsContainer', html);
        } else {
          showEmptyState('requestsContainer', 'No requests found. <a href="create-request.html">Create your first request</a>');
        }
      } catch (error) {
        console.error('Error loading requests:', error);
        hideLoading('requestsContainer', `
          <div class="alert alert-danger">
            Failed to load requests. Please try again.
          </div>
        `);
      }
    }

    // Cancel request
    async function cancelRequest(requestId) {
      if (!confirmDialog('Are you sure you want to cancel this request?')) {
        return;
      }
      
      try {
        const response = await requestAPI.cancelRequest(requestId);
        
        if (response.success) {
          showSuccess('Request cancelled successfully');
          loadRequests(); // Reload the list
        } else {
          showError(response.message || 'Failed to cancel request');
        }
      } catch (error) {
        showError(error.message || 'An error occurred while cancelling the request');
      }
    }

    // Apply filters when changed
    document.getElementById('filterStatus').addEventListener('change', loadRequests);
    document.getElementById('filterType').addEventListener('change', loadRequests);
    document.getElementById('filterPriority').addEventListener('change', loadRequests);

    // Load requests on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadRequests();
    });
  </script>
      </div>
    </main>
  </div>
</body>
</html>
