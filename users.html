<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - DBAMS</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="dashboard.html" class="sidebar-brand">DBAMS</a>
      
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Dashboard</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="requests.html">Requests</a>
        </li>
        <li class="nav-item" data-show-role="Requester,Admin">
          <a class="nav-link" href="create-request.html">Create Request</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="pending-approvals.html">Pending Approvals</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="delegations.html">Delegations</a>
        </li>
        <li class="nav-item" data-show-role="Approver,Admin">
          <a class="nav-link" href="create-delegation.html">Create Delegation</a>
        </li>
        <li class="nav-item" data-show-role="Admin">
          <a class="nav-link active" href="users.html">Users</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profile.html">Profile</a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-name" id="userName">User</div>
          <div class="sidebar-user-role" id="userRole">Role</div>
          <a href="#" class="sidebar-logout" onclick="logout()">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container-fluid">
      <!-- Page Header -->
      <div class="page-header">
        <h2 class="page-title">User Management</h2>
        <p class="text-muted mb-0">Manage system users and their roles.</p>
      </div>

      <!-- Filters -->
      <div class="filter-section">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="filterRole" class="form-label">Role</label>
            <select class="form-select" id="filterRole">
              <option value="">All Roles</option>
              <option value="Admin">Admin</option>
              <option value="Approver">Approver</option>
              <option value="Requester">Requester</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label for="filterStatus" class="form-label">Status</label>
            <select class="form-select" id="filterStatus">
              <option value="">All</option>
              <option value="true" selected>Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          
          <div class="col-md-4">
            <label for="searchUser" class="form-label">Search</label>
            <input 
              type="text" 
              class="form-control" 
              id="searchUser"
              placeholder="Search by name or email..."
            >
          </div>
          
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" onclick="loadUsers()">Search</button>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-header">All Users</div>
        <div class="card-body">
          <div id="usersContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserId">
            
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editName" maxlength="50" required>
            </div>
            
            <div class="mb-3">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            
            <div class="mb-3">
              <label for="editRole" class="form-label">Role</label>
              <select class="form-select" id="editRole" required>
                <option value="Requester">Requester</option>
                <option value="Approver">Approver</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="editDepartment" class="form-label">Department</label>
              <input type="text" class="form-control" id="editDepartment">
            </div>
            
            <div class="mb-3">
              <label for="editPosition" class="form-label">Position</label>
              <input type="text" class="form-control" id="editPosition">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- App Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  
  <script>
    let editModal;
    let allUsers = [];

    // Load users
    async function loadUsers() {
      showLoading('usersContainer');
      
      try {
        const response = await userAPI.getUsers();
        
        if (response.success && response.data) {
          allUsers = response.data;
          filterAndDisplayUsers();
        } else {
          showEmptyState('usersContainer', 'No users found');
        }
      } catch (error) {
        console.error('Error loading users:', error);
        hideLoading('usersContainer', '<div class="alert alert-danger">Failed to load users</div>');
      }
    }

    // Filter and display users
    function filterAndDisplayUsers() {
      let users = [...allUsers];
      
      // Apply role filter
      const roleFilter = document.getElementById('filterRole').value;
      if (roleFilter) {
        users = users.filter(u => u.role === roleFilter);
      }
      
      // Apply status filter
      const statusFilter = document.getElementById('filterStatus').value;
      if (statusFilter) {
        const isActive = statusFilter === 'true';
        users = users.filter(u => u.isActive === isActive);
      }
      
      // Apply search filter
      const searchTerm = document.getElementById('searchUser').value.toLowerCase().trim();
      if (searchTerm) {
        users = users.filter(u => 
          u.name.toLowerCase().includes(searchTerm) || 
          u.email.toLowerCase().includes(searchTerm)
        );
      }
      
      if (users.length === 0) {
        showEmptyState('usersContainer', 'No users match your filters');
        return;
      }
      
      // Display users
      const html = `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Department</th>
                <th>Position</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr>
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td><span class="badge badge-primary">${user.role}</span></td>
                  <td>${user.department || '-'}</td>
                  <td>${user.position || '-'}</td>
                  <td>
                    ${user.isActive 
                      ? '<span class="badge badge-success">Active</span>' 
                      : '<span class="badge badge-secondary">Inactive</span>'}
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-sm btn-outline-primary" onclick='editUser(${JSON.stringify(user)})'>Edit</button>
                      ${user.isActive 
                        ? `<button class="btn btn-sm btn-danger" onclick="deactivateUser('${user._id}', '${user.name}')">Deactivate</button>`
                        : '<span class="text-muted">-</span>'}
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      hideLoading('usersContainer', html);
    }

    // Edit user
    function editUser(user) {
      document.getElementById('editUserId').value = user._id;
      document.getElementById('editName').value = user.name;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editRole').value = user.role;
      document.getElementById('editDepartment').value = user.department || '';
      document.getElementById('editPosition').value = user.position || '';
      
      editModal.show();
    }

    // Save user changes
    document.getElementById('saveUserBtn').addEventListener('click', async function() {
      const userId = document.getElementById('editUserId').value;
      const userData = {
        name: document.getElementById('editName').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        role: document.getElementById('editRole').value,
        department: document.getElementById('editDepartment').value.trim(),
        position: document.getElementById('editPosition').value.trim()
      };
      
      if (!userData.name || !userData.email || !userData.role) {
        showError('Please fill in all required fields');
        return;
      }
      
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
      
      try {
        const response = await userAPI.updateUser(userId, userData);
        
        if (response.success) {
          showSuccess('User updated successfully');
          editModal.hide();
          loadUsers();
        } else {
          showError(response.message || 'Failed to update user');
        }
      } catch (error) {
        showError(error.message || 'An error occurred');
      } finally {
        this.disabled = false;
        this.innerHTML = 'Save Changes';
      }
    });

    // Deactivate user
    async function deactivateUser(userId, userName) {
      if (!confirmDialog(`Are you sure you want to deactivate user "${userName}"?`)) {
        return;
      }
      
      try {
        const response = await userAPI.deactivateUser(userId);
        
        if (response.success) {
          showSuccess('User deactivated successfully');
          loadUsers();
        } else {
          showError(response.message || 'Failed to deactivate user');
        }
      } catch (error) {
        showError(error.message || 'An error occurred');
      }
    }

    // Apply filters
    document.getElementById('filterRole').addEventListener('change', filterAndDisplayUsers);
    document.getElementById('filterStatus').addEventListener('change', filterAndDisplayUsers);
    document.getElementById('searchUser').addEventListener('input', debounce(filterAndDisplayUsers, 300));

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      requireRole('Admin');
      editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
      loadUsers();
    });
  </script>
      </div>
    </main>
  </div>
</body>
</html>
